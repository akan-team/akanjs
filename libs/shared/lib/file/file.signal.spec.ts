import { dayjs } from "@akanjs/base";
import { sleep } from "@akanjs/common";
import { WebFile } from "@akanjs/test";

import * as cnst from "../cnst";
import { fetch } from "../sig";

export const imageBase64 = `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`;

export const getFileInputSamples = (num = 1): [fileList: FileList, metas: cnst.FileMeta[]] => {
  const buffers = new Array(num).fill(imageBase64).map((base64: string) => Buffer.from(base64, "base64"));
  const files = buffers.map((buffer) => new WebFile([buffer], "image.jpg", { type: "image/jpeg" }));
  const metas = files.map((file) => ({ lastModifiedAt: dayjs(), size: file.size }));
  return [files as unknown as FileList, metas];
};

export const addAndWaitActiveFiles = async (
  fileList: FileList,
  metas: cnst.FileMeta[],
  type = "test",
  parentId?: string
) => {
  // 1. 파일 업로드
  const files = await fetch.addFiles(fileList, metas, type, parentId);

  // 2. 파일 업로드 완료 대기
  const MAX_TRY_NUM = 5;
  const activeFiles = await Promise.all(
    files.map(async (file) => {
      expect(file).toMatchObject({ status: "uploading", size: metas[0].size });

      for (let i = 0; i < MAX_TRY_NUM; i++) {
        await sleep(1000);
        file = await fetch.lightFile(file.id);
        if (file.status !== "uploading") break;
      }
      expect(file.status).toEqual("active");
      expect(file.url.length).toBeGreaterThan(0);
      expect(file.abstractData?.length).toBeGreaterThan(0);
      return file;
    })
  );

  // 3. 파일 반환
  return activeFiles;
};

export const getActiveFiles = async (num = 1): Promise<cnst.LightFile[]> => {
  const [fileList, metas] = getFileInputSamples(num);
  const files = await addAndWaitActiveFiles(fileList, metas);
  return files;
};
